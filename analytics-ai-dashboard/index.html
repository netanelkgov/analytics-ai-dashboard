<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דשבורד ממשלתי מתקדם - AI Analytics</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap');
        
        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Assistant', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #2d1b69 100%);
            color: white;
            direction: rtl;
            overflow-x: hidden;
            min-height: 100vh;
            font-size: 16px;
        }
        
        /* Login Page Styles */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 25px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        
        .login-logo {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .login-title {
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(45deg, #64ffda, #448aff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            font-size: 16px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 30px;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .input-group {
            position: relative;
        }
        
        .login-input {
            width: 100%;
            padding: 15px 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .login-input::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        .login-input:focus {
            border-color: #64ffda;
            box-shadow: 0 0 15px rgba(100,255,218,0.3);
        }
        
        .login-btn {
            background: linear-gradient(135deg, #64ffda, #448aff);
            border: none;
            border-radius: 12px;
            padding: 15px 20px;
            color: #0f0f23;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(100,255,218,0.3);
        }
        
        .login-error {
            background: rgba(244,67,54,0.2);
            color: #f44336;
            padding: 10px;
            border-radius: 8px;
            font-size: 15px;
            display: none;
        }
        
        /* Dashboard Styles */
        .dashboard {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
.header-left {
    display: flex;
    align-items: center;
    gap: 20px;
}

.logo img {
    height: 100px;
    width: auto;
    margin-left: 10px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    vertical-align: middle;
}
        
        .logo {
            font-size: 32px;
        }
        
        .title-section h1 {
            font-size: 30px;
            font-weight: 700;
            background: linear-gradient(45deg, #64ffda, #448aff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 16px;
            color: rgba(255,255,255,0.7);
        }
        
        .credit {
            font-size: 13px;
            color: rgba(100,255,218,0.8);
            margin-top: 8px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
.header-right {
    display: flex;
    align-items: center;
    gap: 15px;
    justify-content: flex-end;
    flex-wrap: wrap;
}

.header-right > * {
    height: 40px; /* גובה אחיד לכל הכפתורים */
    display: flex;
    align-items: center;
    justify-content: center;
}

.user-info {
    order: 3; /* מזיז את שם המשתמש לצד שמאל */
}

.ai-analyst-btn {
    order: 2;
}

.permissions-btn {
    order: 1;
}
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 10px 15px;
        }
        
        .user-name {
            font-size: 16px;
            font-weight: 600;
			color: #0f0f23;
        }
        
        .logout-btn {
            background: rgba(244,67,54,0.2);
            border: 1px solid rgba(244,67,54,0.3);
            border-radius: 8px;
            padding: 6px 12px;
            color: #f44336;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: #f44336;
            color: white;
        }
        
        .ai-analyst-btn {
            background: linear-gradient(135deg, #ff6b9d, #c44569);
            border: none;
            border-radius: 15px;
            padding: 15px 25px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            box-shadow: 0 10px 25px rgba(255,107,157,0.3);
            position: relative;
            overflow: hidden;
        }
        
        .ai-analyst-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(255,107,157,0.4);
        }
        
        .ai-analyst-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .ai-analyst-btn:hover::before {
            left: 100%;
        }
        
        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(100,255,218,0.1), rgba(68,138,255,0.1));
            border: 1px solid rgba(100,255,218,0.2);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #64ffda, #448aff);
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(100,255,218,0.2);
        }
        
        .stat-icon {
            font-size: 36px;
            margin-bottom: 12px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #64ffda;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 16px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 10px;
        }
        
        .stat-change {
            font-size: 14px;
            padding: 6px 10px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .stat-change.positive {
            background: rgba(76,175,80,0.2);
            color: #4caf50;
        }
        
        .stat-change.negative {
            background: rgba(244,67,54,0.2);
            color: #f44336;
        }
        
        /* Filters Section */
        .filters-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .filter-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .filter-title {
            font-size: 18px;
            font-weight: 600;
            color: #64ffda;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .filter-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 10px 18px;
            color: white;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-btn:hover, .filter-btn.active {
            background: linear-gradient(135deg, #64ffda, #448aff);
            color: #0f0f23;
            transform: translateY(-2px);
        }
        
        .date-range-inputs {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .date-input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 10px 12px;
            color: white;
            font-size: 14px;
            outline: none;
        }
        
        .date-input:focus {
            border-color: #64ffda;
            box-shadow: 0 0 10px rgba(100,255,218,0.3);
        }
        
        .search-input {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 14px 18px;
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .search-input::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        .search-input:focus {
            border-color: #64ffda;
            box-shadow: 0 0 10px rgba(100,255,218,0.3);
        }
        
        /* Service Pages Section */
        .service-pages-section {
            background: linear-gradient(135deg, rgba(68,138,255,0.1), rgba(100,255,218,0.1));
            border: 1px solid rgba(68,138,255,0.2);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .service-pages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .service-pages-title {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(45deg, #448aff, #64ffda);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .service-pages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
        }
        
        .service-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
            border: 1px solid rgba(68,138,255,0.2);
            border-radius: 15px;
            padding: 22px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .service-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #448aff, #64ffda);
        }
        
        .service-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(68,138,255,0.2);
        }
        
        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .service-info {
            flex: 1;
        }
        
        .service-name {
            font-size: 17px;
            font-weight: 600;
            color: #448aff;
            margin-bottom: 5px;
        }
        
        .service-ministry {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
        }
        
        .service-rank {
            background: linear-gradient(135deg, #448aff, #64ffda);
            color: white;
            font-size: 13px;
            font-weight: 700;
            padding: 6px 10px;
            border-radius: 12px;
            min-width: 40px;
            text-align: center;
        }
        
        .service-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }
        
        .service-metric {
            text-align: center;
        }
        
        .service-metric-value {
            font-size: 18px;
            font-weight: 700;
            color: #64ffda;
            display: block;
        }
        
        .service-metric-label {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            margin-top: 3px;
        }
        
        /* Ministries Spotlight */
        .ministries-spotlight {
            background: linear-gradient(135deg, rgba(255,193,7,0.1), rgba(255,152,0,0.1));
            border: 1px solid rgba(255,193,7,0.2);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .spotlight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .spotlight-title {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(45deg, #ffc107, #ff9800);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .spotlight-tabs {
            display: flex;
            gap: 8px;
        }
        
        .spotlight-tab {
            background: rgba(255,193,7,0.2);
            border: 1px solid rgba(255,193,7,0.3);
            border-radius: 20px;
            padding: 10px 18px;
            color: #ffc107;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .spotlight-tab:hover, .spotlight-tab.active {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: #0f0f23;
        }
        
        .ministries-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .ministry-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
            border: 1px solid rgba(255,193,7,0.2);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .ministry-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ffc107, #ff9800);
        }
        
        .ministry-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(255,193,7,0.2);
        }
        
        .ministry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .ministry-name {
            font-size: 17px;
            font-weight: 600;
            color: #ffc107;
        }
        
        .ministry-rank {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: #0f0f23;
            font-size: 13px;
            font-weight: 700;
            padding: 6px 10px;
            border-radius: 12px;
        }
        
        .ministry-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        /* Mini AI Insights */
        .mini-ai-insights {
            background: linear-gradient(135deg, rgba(255,107,157,0.1), rgba(196,69,105,0.1));
            border: 1px solid rgba(255,107,157,0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .mini-ai-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .mini-ai-title {
            font-size: 20px;
            font-weight: 700;
            color: #ff6b9d;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .deep-insights-btn {
            background: linear-gradient(135deg, #ff6b9d, #c44569);
            border: none;
            border-radius: 10px;
            padding: 10px 18px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .deep-insights-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(255,107,157,0.3);
        }
        
        .quick-insights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .quick-insight {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            border-right: 3px solid #ff6b9d;
        }
        
        .quick-insight-title {
            font-size: 14px;
            font-weight: 600;
            color: #ff6b9d;
            margin-bottom: 8px;
        }
        
        .quick-insight-text {
            font-size: 13px;
            line-height: 1.4;
            color: rgba(255,255,255,0.9);
        }
        
        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .chart-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 20px;
            font-weight: 600;
            color: #64ffda;
        }
        
        .chart-actions {
            display: flex;
            gap: 8px;
        }
        
        .chart-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            padding: 8px 14px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chart-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .chart-placeholder {
            height: 400px;
            background: linear-gradient(45deg, rgba(100,255,218,0.1), rgba(68,138,255,0.1));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.6);
            font-size: 18px;
            position: relative;
            overflow: hidden;
        }
        
        /* Data Table */
        .data-table {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            overflow-x: auto;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #64ffda;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #64ffda, #448aff);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            color: #0f0f23;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(100,255,218,0.3);
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .data-item {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }
        
        .data-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .item-title {
            font-size: 16px;
            font-weight: 600;
            color: #64ffda;
        }
        
        .item-type {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .type-ministry {
            background: rgba(100,255,218,0.2);
            color: #64ffda;
        }
        
        .type-service {
            background: rgba(68,138,255,0.2);
            color: #448aff;
        }
        
        .type-cluster {
            background: rgba(124,77,255,0.2);
            color: #7c4dff;
        }
        
        .item-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .metric {
            text-align: center;
        }
        
        .metric-value {
            font-size: 18px;
            font-weight: 700;
            color: white;
        }
        
        .metric-label {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            margin-top: 2px;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: linear-gradient(135deg, rgba(15,15,35,0.95), rgba(26,26,62,0.95));
            border: 1px solid rgba(255,107,157,0.3);
            border-radius: 25px;
            padding: 40px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,107,157,0.2);
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(45deg, #ff6b9d, #c44569);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: rgba(255,107,157,0.2);
            transform: rotate(90deg);
        }
        
        .insights-grid {
            display: grid;
            gap: 20px;
        }
        
        .insight-category {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255,107,157,0.1);
        }
        
        .category-title {
            font-size: 18px;
            font-weight: 600;
            color: #ff6b9d;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .detailed-insight {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 15px;
            border-right: 4px solid #ff6b9d;
        }
        
        .insight-title {
            font-size: 14px;
            font-weight: 600;
            color: #ff6b9d;
            margin-bottom: 8px;
        }
        
        .insight-text {
            font-size: 13px;
            line-height: 1.6;
            color: rgba(255,255,255,0.9);
            margin-bottom: 10px;
        }
        
        .insight-recommendation {
            font-size: 12px;
            color: #64ffda;
            background: rgba(100,255,218,0.1);
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 8px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,107,157,0.3);
            border-top: 3px solid #ff6b9d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        /* User Management Modal Styles */
        .permissions-btn {
            background: linear-gradient(135deg, #9c27b0, #673ab7);
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
            box-shadow: 0 8px 20px rgba(156,39,176,0.3);
        }

        .permissions-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(156,39,176,0.4);
        }

        .permissions-modal .modal-content {
            max-width: 1000px;
            background: linear-gradient(135deg, rgba(15,15,35,0.98), rgba(26,26,62,0.98));
        }

        .permissions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(156,39,176,0.3);
        }

        .permissions-title {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(45deg, #9c27b0, #673ab7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .users-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .add-user-form, .users-list {
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
            border: 1px solid rgba(156,39,176,0.2);
            border-radius: 15px;
            padding: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #9c27b0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            color: rgba(255,255,255,0.8);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .form-input, .form-select {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 12px 15px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .form-input:focus, .form-select:focus {
            border-color: #9c27b0;
            box-shadow: 0 0 10px rgba(156,39,176,0.3);
        }

        .add-user-btn {
            background: linear-gradient(135deg, #9c27b0, #673ab7);
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .add-user-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(156,39,176,0.3);
        }

        .add-user-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .user-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .user-item:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(156,39,176,0.3);
        }

.user-info {
    background: linear-gradient(135deg, #64ffda, #448aff);
    border: none;
    border-radius: 12px;
    padding: 12px 20px;
    color: #0f0f23;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 20px rgba(100,255,218,0.3);
    display: flex;
    align-items: center;
    gap: 10px;
}

.user-info:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 25px rgba(100,255,218,0.4);
}

        .user-details {
            flex: 1;
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
            color: #9c27b0;
            margin-bottom: 3px;
        }

        .user-email {
            font-size: 13px;
            color: rgba(255,255,255,0.7);
        }

        .user-role {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .role-admin {
            background: rgba(244,67,54,0.2);
            color: #f44336;
        }

        .role-analyst {
            background: rgba(68,138,255,0.2);
            color: #448aff;
        }

        .role-viewer {
            background: rgba(76,175,80,0.2);
            color: #4caf50;
        }

        .role-project-manager {
            background: rgba(255,193,7,0.2);
            color: #ffc107;
        }

        .user-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .edit-user-btn, .delete-user-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edit-user-btn {
            background: rgba(68,138,255,0.2);
            color: #448aff;
        }

        .edit-user-btn:hover {
            background: #448aff;
            color: white;
        }

        .delete-user-btn {
            background: rgba(244,67,54,0.2);
            color: #f44336;
        }

        .delete-user-btn:hover {
            background: #f44336;
            color: white;
        }

        .success-message, .error-message {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: 500;
        }

        .success-message {
            background: rgba(76,175,80,0.2);
            color: #4caf50;
            border: 1px solid rgba(76,175,80,0.3);
        }

        .error-message {
            background: rgba(244,67,54,0.2);
            color: #f44336;
            border: 1px solid rgba(244,67,54,0.3);
        }

        .permissions-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: linear-gradient(135deg, rgba(156,39,176,0.1), rgba(103,58,183,0.1));
            border: 1px solid rgba(156,39,176,0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #9c27b0;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255,255,255,0.6);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .empty-state-subtext {
            font-size: 14px;
            opacity: 0.7;
        }
        
        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            animation: fadeInUp 0.5s ease-out;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
		
		.admin-settings {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px;
    border-radius: 15px;
    margin: 20px 0;
    display: none;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
}

.admin-form {
    display: grid;
    gap: 15px;
    max-width: 400px;
}

.admin-form input {
    padding: 12px 15px;
    border: none;
    border-radius: 8px;
    background: rgba(255,255,255,0.9);
    color: #333;
    font-size: 14px;
    outline: none;
    transition: all 0.3s ease;
}

.admin-form input:focus {
    box-shadow: 0 0 10px rgba(100,255,218,0.3);
}

.admin-form button {
    padding: 12px 20px;
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.admin-form button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(76,175,80,0.3);
}

.admin-form .cancel-btn {
    background: linear-gradient(135deg, #f44336, #d32f2f);
}

.admin-form .cancel-btn:hover {
    box-shadow: 0 8px 16px rgba(244,67,54,0.3);
}
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .modal-content {
                padding: 20px;
                margin: 10px;
            }
            
            .ministries-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-insights {
                grid-template-columns: 1fr;
            }
            
            .users-section {
                grid-template-columns: 1fr;
            }
            
            .permissions-stats {
                grid-template-columns: 1fr 1fr;
            }
        }
		
		/* User Profile Modal */
.profile-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(15px);
    z-index: 2500;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.profile-modal-content {
    background: linear-gradient(135deg, rgba(15,15,35,0.95), rgba(26,26,62,0.95));
    border: 1px solid rgba(100,255,218,0.3);
    border-radius: 25px;
    padding: 40px;
    max-width: 500px;
    width: 100%;
    backdrop-filter: blur(20px);
    box-shadow: 0 25px 50px rgba(0,0,0,0.5);
}

.profile-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(100,255,218,0.2);
}

.profile-title {
    font-size: 24px;
    font-weight: 700;
    background: linear-gradient(45deg, #64ffda, #448aff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    display: flex;
    align-items: center;
    gap: 12px;
}

.profile-form {
    display: grid;
    gap: 20px;
}

.profile-form-group {
    position: relative;
}

.profile-form-label {
    display: block;
    color: rgba(255,255,255,0.8);
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 8px;
}

.profile-form-input {
    width: 100%;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 12px;
    padding: 15px 20px;
    color: white;
    font-size: 16px;
    outline: none;
    transition: all 0.3s ease;
    font-family: 'Assistant', sans-serif;
}

.profile-form-input::placeholder {
    color: rgba(255,255,255,0.5);
}

.profile-form-input:focus {
    border-color: #64ffda;
    box-shadow: 0 0 15px rgba(100,255,218,0.3);
    background: rgba(255,255,255,0.15);
}

.profile-actions {
    display: flex;
    gap: 15px;
    margin-top: 20px;
}

.profile-save-btn {
    flex: 1;
    background: linear-gradient(135deg, #64ffda, #448aff);
    border: none;
    border-radius: 12px;
    padding: 15px 20px;
    color: #0f0f23;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
}

.profile-save-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(100,255,218,0.3);
}

.profile-cancel-btn {
    flex: 1;
    background: rgba(244,67,54,0.2);
    border: 1px solid rgba(244,67,54,0.3);
    border-radius: 12px;
    padding: 15px 20px;
    color: #f44336;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.profile-cancel-btn:hover {
    background: #f44336;
    color: white;
    transform: translateY(-2px);
}

.profile-message {
    padding: 12px 18px;
    border-radius: 10px;
    margin-bottom: 20px;
    font-size: 14px;
    font-weight: 500;
}

.profile-success {
    background: rgba(76,175,80,0.2);
    color: #4caf50;
    border: 1px solid rgba(76,175,80,0.3);
}

.profile-error {
    background: rgba(244,67,54,0.2);
    color: #f44336;
    border: 1px solid rgba(244,67,54,0.3);
}

.user-role-display {
    background: linear-gradient(135deg, rgba(100,255,218,0.1), rgba(68,138,255,0.1));
    border: 1px solid rgba(100,255,218,0.2);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
}

.role-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.role-label {
    color: rgba(255,255,255,0.8);
    font-size: 14px;
}

.role-value {
    background: linear-gradient(135deg, #64ffda, #448aff);
    color: #0f0f23;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
}
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-logo"><img src="gov_logo.png" alt="לוגו gov.il" style="height: 220px; width: auto; opacity: 0.9;"></div>
            <div class="login-title">דשבורד ממשלתי מתקדם</div>
            <div class="login-subtitle">מערכת ניתוח נתונים עם בינה מלאכותית</div>
            
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="input-group">
                    <input type="email" class="login-input" id="email" placeholder="כתובת אימייל" required>
                </div>
                <div class="input-group">
                    <input type="password" class="login-input" id="password" placeholder="סיסמה" required>
                </div>
                <div class="login-error" id="loginError"></div>
                <button type="submit" class="login-btn">כניסה למערכת</button>
            </form>
            
            <div style="margin-top: 20px; font-size: 12px; color: rgba(255,255,255,0.5);">
                פותח על ידי נתנאל קופרמן - יועץ טכנולוגי, מפתח מערכות
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardPage" class="dashboard">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="logo"><img src="digital_logo_clear.png" alt="לוגו מערך הדיגיטל"></div>
                <div class="title-section">
                    <h1>דשבורד ממשלתי מתקדם</h1>
                    <div class="subtitle">מערכת ניתוח נתונים עם בינה מלאכותית</div>
                    <div class="credit">פותח על ידי נתנאל קופרמן - יועץ טכנולוגי, מפתח מערכות</div>
                </div>
            </div>
            <div class="header-right">
<div class="user-info" onclick="openProfileModal()" style="cursor: pointer;">
    <span>👤</span>
    <span class="user-name" id="currentUserName">נתנאל קופרמן</span>
    <button class="logout-btn" onclick="event.stopPropagation(); logout()">יציאה</button>
</div>
                <button class="ai-analyst-btn" onclick="openDeepInsights()">
                    🤖 אנליסט AI מתקדם
                </button>
                <button class="permissions-btn" onclick="openPermissionsModal()">
                    👥 ניהול משתמשים
                </button>
            </div>
        </div>
	
        <!-- Stats Overview -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon">👥</div>
                <div class="stat-value" id="total-users">0</div>
                <div class="stat-label">משתמשים יחודיים</div>
                <div class="stat-change positive">↗ ממתין לנתונים</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">📄</div>
                <div class="stat-value" id="total-pageviews">0</div>
                <div class="stat-label">צפיות בדפים</div>
                <div class="stat-change positive">↗ ממתין לנתונים</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">🔧</div>
                <div class="stat-value" id="active-services">0</div>
                <div class="stat-label">שירותים פעילים</div>
                <div class="stat-change positive">↗ ממתין לנתונים</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">⏱️</div>
                <div class="stat-value" id="avg-session-time">0:00</div>
                <div class="stat-label">זמן שהייה ממוצע</div>
                <div class="stat-change positive">↗ ממתין לנתונים</div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filter-card">
                <div class="filter-title">🏛️ סוג דף</div>
                <div class="filter-options">
                    <button class="filter-btn active" data-filter="all">הכל</button>
                    <button class="filter-btn" data-filter="ministry">דפי משרד</button>
                    <button class="filter-btn" data-filter="service">דפי שירות</button>
                    <button class="filter-btn" data-filter="cluster">דפי צובר</button>
                </div>
            </div>
            
            <div class="filter-card">
                <div class="filter-title">📅 תקופת זמן</div>
                <div class="filter-options">
                    <button class="filter-btn" data-period="today">היום (29/07/25)</button>
                    <button class="filter-btn active" data-period="week">השבוע (23-29/07)</button>
                    <button class="filter-btn" data-period="month">החודש (יולי 2025)</button>
                    <button class="filter-btn" data-period="quarter">הרבעון (Q3 2025)</button>
                </div>
                <div class="date-range-inputs">
                    <input type="date" class="date-input" id="startDate" value="2025-07-23">
                    <input type="date" class="date-input" id="endDate" value="2025-07-29">
                    <button class="filter-btn" onclick="applyCustomRange()">🔍 החל</button>
                </div>
            </div>
            
            <div class="filter-card">
                <div class="filter-title">🔍 חיפוש מתקדם</div>
                <input type="text" class="search-input" placeholder="חפש משרד, שירות או URL..." oninput="filterData(this.value)">
            </div>
        </div>

        <!-- Service Pages Section -->
        <div class="service-pages-section">
            <div class="service-pages-header">
                <div class="service-pages-title">
                    🏆 דפי שירות מובילים
                </div>
            </div>
            <div class="service-pages-grid" id="servicePages">
                <!-- דפי השירות המובילים יוצגו כאן -->
            </div>
        </div>

        <!-- Ministries Spotlight -->
        <div class="ministries-spotlight">
            <div class="spotlight-header">
                <div class="spotlight-title">
                    ⭐ משרדים במרכז הזרקור
                </div>
                <div class="spotlight-tabs">
                    <button class="spotlight-tab active" data-metric="traffic">תנועה</button>
                    <button class="spotlight-tab" data-metric="conversion">המרה</button>
                    <button class="spotlight-tab" data-metric="engagement">מעורבות</button>
                    <button class="spotlight-tab" data-metric="performance">ביצועים</button>
                </div>
            </div>
            <div class="ministries-grid" id="ministriesGrid">
                <!-- המשרדים המובילים יוצגו כאן -->
            </div>
        </div>

        <!-- Mini AI Insights -->
        <div class="mini-ai-insights">
            <div class="mini-ai-header">
                <div class="mini-ai-title">
                    🤖 תובנות AI מהירות
                </div>
                <button class="deep-insights-btn" onclick="openDeepInsights()">
                    🔬 ניתוח מעמיק
                </button>
            </div>
            <div class="quick-insights">
                <div class="quick-insight">
                    <div class="quick-insight-title">📈 מגמה חמה</div>
                    <div class="quick-insight-text">ממתין לחיבור ל-Google Analytics</div>
                </div>
                <div class="quick-insight">
                    <div class="quick-insight-title">⚡ נקודת תשומת לב</div>
                    <div class="quick-insight-text">ממתין לחיבור ל-Google Analytics</div>
                </div>
                <div class="quick-insight">
                    <div class="quick-insight-title">💡 הזדמנות</div>
                    <div class="quick-insight-text">ממתין לחיבור ל-Google Analytics</div>
                </div>
                <div class="quick-insight">
                    <div class="quick-insight-title">🏆 המלצה</div>
                    <div class="quick-insight-text">ממתין לחיבור ל-Google Analytics</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="charts-section">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">📊 תנועה לפי סוג דף</div>
                        <div class="chart-actions">
                            <button class="chart-btn">יום</button>
                            <button class="chart-btn">שבוע</button>
                            <button class="chart-btn">חודש</button>
                        </div>
                    </div>
                    <div class="chart-placeholder" id="traffic-chart">
                        <canvas id="trafficCanvas" width="500" height="350"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">🏆 ביצועי שירותים מובילים</div>
                        <div class="chart-actions">
                            <button class="chart-btn">מובילים</button>
                            <button class="chart-btn">פופולריים</button>
                        </div>
                    </div>
                    <div class="chart-placeholder" id="services-chart">
                        <canvas id="servicesCanvas" width="500" height="350"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="data-table">
            <div class="table-header">
                <div class="table-title">📋 נתוני דפים מפורטים</div>
                <button class="export-btn" onclick="exportData('excel')">📤 יצוא Excel</button>
            </div>
            
            <div class="data-grid" id="data-grid">
                <!-- הנתונים יוצגו באופן דינמי ב-JavaScript -->
            </div>
        </div>
    </div>

    <!-- Deep AI Insights Modal -->
    <div class="modal" id="aiModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    🤖 אנליסט AI - ניתוח מעמיק
                </div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <div id="modalInsightsContent">
                <div style="text-align: center; padding: 40px;">
                    <div class="loading-spinner"></div>
                    <div style="color: #ff6b9d; font-size: 16px;">האנליסט AI מנתח את הנתונים בעומק...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Permissions Management Modal -->
    <div class="modal permissions-modal" id="permissionsModal">
        <div class="modal-content">
            <div class="permissions-header">
                <div class="permissions-title">
                    👥 ניהול משתמשים והרשאות
                </div>
                <button class="close-btn" onclick="closePermissionsModal()">&times;</button>
            </div>
		
            
            <!-- Statistics -->
            <div class="permissions-stats">
                <div class="stat-box">
                    <span class="stat-number" id="totalUsersCount">3</span>
                    <div class="stat-label">סה"כ משתמשים</div>
                </div>
                <div class="stat-box">
                    <span class="stat-number" id="adminUsersCount">1</span>
                    <div class="stat-label">מנהלי מערכת</div>
                </div>
                <div class="stat-box">
                    <span class="stat-number" id="activeUsersCount">3</span>
                    <div class="stat-label">משתמשים פעילים</div>
                </div>
                <div class="stat-box">
                    <span class="stat-number" id="onlineUsersCount">1</span>
                    <div class="stat-label">משתמשים מחוברים</div>
                </div>
            </div>

            <div class="users-section">
                <!-- Add New User Form -->
                <div class="add-user-form">
                    <div class="section-title">
                        ➕ הוספת משתמש חדש
                    </div>
                    
                    <div id="userFormMessage"></div>
                    
                    <form id="addUserForm" onsubmit="addNewUser(event)">
                        <div class="form-group">
                            <label class="form-label" for="newUserName">שם מלא</label>
                            <input type="text" class="form-input" id="newUserName" placeholder="הכנס שם מלא" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="newUserEmail">כתובת אימייל</label>
                            <input type="email" class="form-input" id="newUserEmail" placeholder="user@gov.il" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="newUserPassword">סיסמה ראשונית</label>
                            <input type="password" class="form-input" id="newUserPassword" placeholder="הכנס סיסמה" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="newUserRole">תפקיד</label>
                            <select class="form-select" id="newUserRole" required>
                                <option value="">בחר תפקיד</option>
                                <option value="admin">מנהל</option>
                                <option value="project-manager">מנהל פרויקט</option>
                                <option value="analyst">אנליסט</option>
                                <option value="viewer">צופה</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="add-user-btn" id="addUserBtn">
                            הוסף משתמש
                        </button>
                    </form>
                </div>

                <!-- Users List -->
                <div class="users-list">
                    <div class="section-title">
                        👥 רשימת משתמשים קיימים
                    </div>
                    
                    <div id="usersList">
                        <!-- Users will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
	
				<!-- User Profile Modal -->
<div class="profile-modal" id="profileModal">
    <div class="profile-modal-content">
        <div class="profile-header">
            <div class="profile-title">
                👤 עריכת פרטים אישיים
            </div>
            <button class="close-btn" onclick="closeProfileModal()">&times;</button>
        </div>
        
        <div id="profileMessage"></div>
        
        <div class="user-role-display">
            <div class="role-info">
                <span class="role-label">תפקיד במערכת:</span>
                <span class="role-value" id="currentUserRole">מנהל</span>
            </div>
        </div>
        
        <form class="profile-form" onsubmit="updateUserProfile(event)">
            <div class="profile-form-group">
                <label class="profile-form-label" for="profileName">שם מלא</label>
                <input type="text" class="profile-form-input" id="profileName" placeholder="הכנס שם מלא">
            </div>
            
            <div class="profile-form-group">
                <label class="profile-form-label" for="profileEmail">כתובת אימייל</label>
                <input type="email" class="profile-form-input" id="profileEmail" placeholder="user@gov.il">
            </div>
            
            <div class="profile-form-group">
                <label class="profile-form-label" for="profilePassword">סיסמה חדשה (אופציונאלי)</label>
                <input type="password" class="profile-form-input" id="profilePassword" placeholder="השאר ריק כדי לא לשנות">
            </div>
            
            <div class="profile-actions">
                <button type="submit" class="profile-save-btn">
                    💾 שמור שינויים
                </button>
                <button type="button" class="profile-cancel-btn" onclick="closeProfileModal()">
                    ❌ ביטול
                </button>
            </div>
        </form>
    </div>
</div>

    <script>
	        // ========================================
        // GA4 INTEGRATION CLASSES
        // ========================================
// החלף את מחלקת GA4Manager בקוד הקיים
class GA4Manager {
    constructor() {
        this.credentials = {
            client_id: "437837740990-kt1d6jv6nr87vf8fu0f35ajiok1o4i5n.apps.googleusercontent.com",
            redirect_uri: "https://analytics-ai-dashboard.netlify.app/oauth_callback.html"
        };
        this.accessToken = null;
        this.properties = new Map();
        this.loadPropertiesData();
    }

    loadPropertiesData() {
        const propertiesData = `אגף ביטחון וחירום	352957900
אגף בכיר אזרחים ותיקים	352963050
אגף המפקח הכללי לענייני ביקורת המדינה	352912757
אגף ממשל וחברה	352578462
משרד החינוך	351942527
משרד הבריאות	353425881
משרד האוצר	353720808
משרד המשפטים	314819421
משרד הפנים	353447047
משרד הרווחה והביטחון החברתי	353457976`;

        propertiesData.split('\n').forEach(line => {
            const [name, id] = line.split('\t');
            if (name && id) {
                this.properties.set(id.trim(), name.trim());
            }
        });
    }

    initiateGoogleAuth() {
        const scope = 'https://www.googleapis.com/auth/analytics.readonly';
        const authUrl = `https://accounts.google.com/o/oauth2/auth?` +
            `client_id=${this.credentials.client_id}&` +
            `redirect_uri=${encodeURIComponent(this.credentials.redirect_uri)}&` +
            `scope=${encodeURIComponent(scope)}&` +
            `response_type=code&` +
            `access_type=offline&` +
            `prompt=consent`;
        
        window.open(authUrl, 'google-auth', 'width=500,height=600');
    }

    async exchangeCodeForToken(authCode) {
        try {
            console.log('Exchanging code for token...');
            
            // שימוש ב-Netlify Function במקום קריאה ישירה
            const response = await fetch('/.netlify/functions/ga4-auth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: 'exchange_token',
                    code: authCode
                })
            });

            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || `HTTP ${response.status}`);
            }
            
            if (data.access_token) {
                this.accessToken = data.access_token;
                localStorage.setItem('ga4_access_token', data.access_token);
                if (data.refresh_token) {
                    localStorage.setItem('ga4_refresh_token', data.refresh_token);
                }
                console.log('Token exchange successful!');
                return true;
            }
            
            throw new Error('No access token received');
            
        } catch (error) {
            console.error('Token exchange failed:', error);
            return false;
        }
    }

    async fetchGA4Data(propertyId, startDate = '7daysAgo', endDate = 'today') {
        if (!this.accessToken) {
            this.accessToken = localStorage.getItem('ga4_access_token');
            if (!this.accessToken) {
                throw new Error('No access token available. Please authenticate first.');
            }
        }

        const requestBody = {
            dateRanges: [{
                startDate: startDate,
                endDate: endDate
            }],
            dimensions: [
                { name: 'pagePath' },
                { name: 'pageTitle' }
            ],
            metrics: [
                { name: 'screenPageViews' },
                { name: 'sessions' },
                { name: 'activeUsers' },
                { name: 'averageSessionDuration' },
                { name: 'bounceRate' }
            ],
            limit: 100
        };

        try {
            console.log(`Fetching data for property ${propertyId}...`);
            
            // שימוש ב-Netlify Function במקום קריאה ישירה
            const response = await fetch('/.netlify/functions/ga4-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    propertyId,
                    requestBody,
                    accessToken: this.accessToken
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }

            const data = await response.json();
            return this.processGA4Data(data, propertyId);
            
        } catch (error) {
            console.error('GA4 fetch failed:', error);
            throw error;
        }
    }

    processGA4Data(rawData, propertyId) {
        if (!rawData.rows) {
            return null;
        }

        const propertyName = this.properties.get(propertyId) || `Property ${propertyId}`;
        let totalUsers = 0;
        let totalPageviews = 0;
        let totalSessions = 0;
        let totalDuration = 0;
        let totalBounceRate = 0;

        rawData.rows.forEach(row => {
            const pageViews = parseInt(row.metricValues[0].value) || 0;
            const sessions = parseInt(row.metricValues[1].value) || 0;
            const users = parseInt(row.metricValues[2].value) || 0;
            const avgDuration = parseFloat(row.metricValues[3].value) || 0;
            const bounceRate = parseFloat(row.metricValues[4].value) || 0;

            totalUsers += users;
            totalPageviews += pageViews;
            totalSessions += sessions;
            totalDuration += avgDuration;
            totalBounceRate += bounceRate;
        });

        return {
            propertyId,
            propertyName,
            totalUsers,
            totalPageviews,
            totalSessions,
            avgSessionDuration: totalDuration / rawData.rows.length,
            bounceRate: totalBounceRate / rawData.rows.length,
            conversionRate: Math.random() * 30 + 10, // Placeholder
            lastUpdated: new Date().toISOString()
        };
    }
}

        class DashboardGA4Integration {
            constructor() {
                this.ga4Manager = new GA4Manager();
                this.isConnected = false;
                this.setupUI();
                this.checkExistingAuth();
            }

            setupUI() {
                const headerRight = document.querySelector('.header-right');
                if (headerRight) {
                    const ga4Button = document.createElement('button');
                    ga4Button.className = 'ai-analyst-btn';
                    ga4Button.style.background = 'linear-gradient(135deg, #34a853, #137333)';
                    ga4Button.style.marginLeft = '10px';
                    ga4Button.innerHTML = '📊 התחבר ל-GA4';
                    ga4Button.onclick = () => this.handleGA4Connection();
                    headerRight.insertBefore(ga4Button, headerRight.firstChild);
                    this.ga4Button = ga4Button;
                }
            }

            checkExistingAuth() {
                if (localStorage.getItem('ga4_access_token')) {
                    this.updateConnectionStatus(true);
                }
            }

            async handleGA4Connection() {
                if (!this.isConnected) {
                    this.ga4Manager.initiateGoogleAuth();
                    
                    window.addEventListener('message', async (event) => {
                        if (event.data.type === 'GA4_AUTH_SUCCESS' && event.data.code) {
                            const success = await this.ga4Manager.exchangeCodeForToken(event.data.code);
                            if (success) {
                                this.updateConnectionStatus(true);
                                this.loadRealData();
                            }
                        }
                    });
                } else {
                    this.loadRealData();
                }
            }

            updateConnectionStatus(connected) {
                this.isConnected = connected;
                if (this.ga4Button) {
                    if (connected) {
                        this.ga4Button.innerHTML = '📊 רענן נתונים מ-GA4';
                        this.ga4Button.style.background = 'linear-gradient(135deg, #34a853, #137333)';
                    } else {
                        this.ga4Button.innerHTML = '📊 התחבר ל-GA4';
                        this.ga4Button.style.background = 'linear-gradient(135deg, #ea4335, #d33b2c)';
                    }
                }
            }

            async loadRealData() {
                try {
                    this.showLoadingIndicator();
                    
                    // Test with first 3 properties
                    const propertyIds = Array.from(this.ga4Manager.properties.keys()).slice(0, 3);
                    const results = new Map();

                    for (const propertyId of propertyIds) {
                        try {
                            console.log(`Fetching data for ${this.ga4Manager.properties.get(propertyId)}...`);
                            const data = await this.ga4Manager.fetchGA4Data(propertyId);
                            if (data) {
                                results.set(propertyId, data);
                            }
                            await new Promise(resolve => setTimeout(resolve, 200));
                        } catch (error) {
                            console.error(`Failed to fetch data for property ${propertyId}:`, error);
                        }
                    }
                    
                    if (results.size > 0) {
                        const dashboardData = this.convertGA4DataToDashboard(results);
                        this.updateDashboardWithRealData(dashboardData);
                        alert(`✅ הנתונים עודכנו בהצלחה! נטענו ${results.size} נכסים מ-GA4`);
                    } else {
                        alert('❌ לא נמצאו נתונים. בדוק את ההרשאות ל-GA4');
                    }
                    
                    this.hideLoadingIndicator();
                    
                } catch (error) {
                    this.hideLoadingIndicator();
                    console.error('Failed to load GA4 data:', error);
                    alert('❌ שגיאה בטעינת הנתונים: ' + error.message);
                }
            }

            convertGA4DataToDashboard(ga4Data) {
                const dashboardData = [];
                
                ga4Data.forEach((propertyData, propertyId) => {
                    dashboardData.push({
                        title: propertyData.propertyName,
                        type: this.determinePageType(propertyData.propertyName),
                        url: `/${propertyId}`,
                        users: propertyData.totalUsers,
                        pageviews: propertyData.totalPageviews,
                        services: Math.floor(Math.random() * 20) + 5,
                        avgTime: this.formatDuration(propertyData.avgSessionDuration),
                        bounceRate: Math.round(propertyData.bounceRate * 100) / 100,
                        conversion: Math.round(propertyData.conversionRate * 100) / 100,
                        performance: this.calculatePerformanceScore(propertyData),
                        lastUpdated: propertyData.lastUpdated
                    });
                });
                
                return dashboardData;
            }

            determinePageType(title) {
                if (title.includes('משרד')) return 'ministry';
                if (title.includes('שירות') || title.includes('רשות')) return 'service';
                return 'ministry';
            }

            formatDuration(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }

            calculatePerformanceScore(data) {
                const userScore = Math.min(data.totalUsers / 1000, 100);
                const conversionScore = data.conversionRate * 2;
                const bounceScore = (1 - data.bounceRate) * 100;
                return Math.round((userScore + conversionScore + bounceScore) / 3);
            }

            updateDashboardWithRealData(realData) {
                // Update global mockData
                window.mockData = [...realData, ...mockData.slice(realData.length)];
                
                // Refresh components
                renderData();
                renderServicePages();
                renderMinistriesSpotlight();
                drawCharts();
                this.updateStatsOverview(realData);
            }

            updateStatsOverview(data) {
                const totalUsers = data.reduce((sum, item) => sum + item.users, 0);
                const totalPageviews = data.reduce((sum, item) => sum + item.pageviews, 0);
                
                if (totalUsers > 0) {
                    document.getElementById('total-users').textContent = this.formatNumber(totalUsers);
                    document.getElementById('total-pageviews').textContent = this.formatNumber(totalPageviews);
                }
            }

            formatNumber(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
                return num.toString();
            }

            showLoadingIndicator() {
                const overlay = document.createElement('div');
                overlay.id = 'ga4-loading';
                overlay.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.8); display: flex; align-items: center;
                    justify-content: center; z-index: 9999; color: white; font-size: 18px;
                `;
                overlay.innerHTML = `
                    <div style="text-align: center;">
                        <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                        <div>טוען נתונים מ-Google Analytics 4...</div>
                    </div>
                `;
                document.body.appendChild(overlay);
            }

            hideLoadingIndicator() {
                const overlay = document.getElementById('ga4-loading');
                if (overlay) overlay.remove();
            }
        }
		
        // ========================================
        // GLOBAL VARIABLES
        // ========================================
        let currentFilter = 'all';
        let currentSearch = '';
        let currentMetric = 'traffic';
        let currentUser = null;
        
        // Mock user database - Enhanced with roles and permissions
        const authorizedUsers = {
            'netanel.cooperman@gov.il': {
                name: 'נתנאל קופרמן',
                role: 'admin',
                password: '123456',
                permissions: ['read', 'write', 'delete', 'manage_users'],
                createdAt: '2024-01-15',
                lastLogin: '2025-07-30',
                status: 'active'
            },
            'sarah.cohen@gov.il': {
                name: 'שרה כהן',
                role: 'analyst',
                password: 'password',
                permissions: ['read', 'write'],
                createdAt: '2024-03-20',
                lastLogin: '2025-07-29',
                status: 'active'
            },
            'david.levy@gov.il': {
                name: 'דוד לוי',
                role: 'viewer',
                password: 'viewer123',
                permissions: ['read'],
                createdAt: '2024-06-10',
                lastLogin: '2025-07-28',
                status: 'active'
            }
        };

        // GA4 Data - will be populated from real Analytics data
        let mockData = [];

        // Get service pages only
        let servicePages = [];

        // Role definitions with permissions
        const roleDefinitions = {
            'admin': {
                label: 'מנהל',
                permissions: ['read', 'write', 'delete', 'manage_users', 'export_data', 'system_config'],
                color: '#f44336'
            },
            'project-manager': {
                label: 'מנהל פרויקט',
                permissions: ['read', 'write', 'export_data', 'manage_team'],
                color: '#ffc107'
            },
            'analyst': {
                label: 'אנליסט',
                permissions: ['read', 'write', 'export_data'],
                color: '#448aff'
            },
            'viewer': {
                label: 'צופה',
                permissions: ['read'],
                color: '#4caf50'
            }
        };

        // ========================================
        // AUTHENTICATION FUNCTIONS
        // ========================================
        function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            // Check if user exists and password is correct
            if (authorizedUsers[email] && authorizedUsers[email].password === password) {
                // Check if user is active
                if (authorizedUsers[email].status !== 'active') {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'המשתמש אינו פעיל. פנה למנהל המערכת';
                    setTimeout(() => {
                        errorDiv.style.display = 'none';
                    }, 3000);
                    return;
                }
                
                currentUser = authorizedUsers[email];
                currentUser.email = email; // Store email for reference
                
                // Update last login
                authorizedUsers[email].lastLogin = new Date().toISOString().split('T')[0];
                
                document.getElementById('currentUserName').textContent = currentUser.name;
                
                // Hide login page and show dashboard
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboardPage').style.display = 'block';
                
                // Initialize dashboard
                initializeDashboard();
                
            } else {
                // Show error
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'אימייל או סיסמה שגויים';
                
                // Hide error after 3 seconds
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
        }

        function logout() {
            if (confirm('האם אתה בטוח שברצונך להתנתק?')) {
                currentUser = null;
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('dashboardPage').style.display = 'none';
                
                // Clear form
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
            }
        }

        // ========================================
        // USER MANAGEMENT FUNCTIONS
        // ========================================
        function openPermissionsModal() {
            if (!hasPermission('manage_users')) {
                alert('אין לך הרשאה לנהל משתמשים');
                return;
            }
            
            const modal = document.getElementById('permissionsModal');
            modal.style.display = 'flex';
            
            renderUsersList();
            updatePermissionsStats();
        }

        function closePermissionsModal() {
            document.getElementById('permissionsModal').style.display = 'none';
            clearUserForm();
        }

        function hasPermission(permission) {
            if (!currentUser) return false;
            return currentUser.permissions && currentUser.permissions.includes(permission);
        }

        function renderUsersList() {
            const usersList = document.getElementById('usersList');
            const users = Object.entries(authorizedUsers);
            
            if (users.length === 0) {
                usersList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">👥</div>
                        <div class="empty-state-text">אין משתמשים רשומים</div>
                        <div class="empty-state-subtext">הוסף משתמש חדש למערכת</div>
                    </div>
                `;
                return;
            }
            
            usersList.innerHTML = users.map(([email, user]) => `
                <div class="user-item fade-in">
                    <div class="user-info">
                        <div class="user-details">
                            <div class="user-name">${user.name}</div>
                            <div class="user-email">${email}</div>
                        </div>
                        <div class="user-role role-${user.role}">
                            ${roleDefinitions[user.role]?.label || user.role}
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="edit-user-btn" onclick="editUser('${email}')">
                            עריכה
                        </button>
                        ${email !== currentUser?.email ? `
                            <button class="delete-user-btn" onclick="deleteUser('${email}')">
                                מחיקה
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function addNewUser(event) {
            event.preventDefault();
            
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            // Validation
            if (!name || !email || !password || !role) {
                showUserFormMessage('אנא מלא את כל השדות', 'error');
                return;
            }
            
            if (authorizedUsers[email]) {
                showUserFormMessage('אימייל זה כבר רשום אצל משתמש אחר', 'error');
                return;
            }
            
            if (!email.endsWith('@gov.il')) {
                showUserFormMessage('רק כתובות ממשלתיות מאושרות ב-@gov.il', 'error');
                return;
            }
            
            // Add new user
            const newUser = {
                name: name,
                role: role,
                password: password,
                permissions: roleDefinitions[role].permissions,
                createdAt: new Date().toISOString().split('T')[0],
                lastLogin: null,
                status: 'active'
            };
            
            authorizedUsers[email] = newUser;
            
            showUserFormMessage(`✅ המשתמש ${name} נוסף בהצלחה למערכת`, 'success');
            clearUserForm();
            renderUsersList();
            updatePermissionsStats();
            
            // Auto-hide success message after 3 seconds
            setTimeout(() => {
                document.getElementById('userFormMessage').innerHTML = '';
            }, 3000);
        }

        function editUser(email) {
            const user = authorizedUsers[email];
            if (!user) return;
            
            const newRole = prompt(`עריכת תפקיד עבור ${user.name}\n\nתפקידים זמינים:\n- admin (מנהל)\n- project-manager (מנהל פרויקט)\n- analyst (אנליסט)\n- viewer (צופה)\n\nתפקיד נוכחי: ${user.role}`, user.role);
            
            if (newRole && newRole !== user.role && roleDefinitions[newRole]) {
                user.role = newRole;
                user.permissions = roleDefinitions[newRole].permissions;
                
                showUserFormMessage(`✅ התפקיד עבור ${user.name} עודכן ל-${roleDefinitions[newRole].label}`, 'success');
                renderUsersList();
                updatePermissionsStats();
                
                setTimeout(() => {
                    document.getElementById('userFormMessage').innerHTML = '';
                }, 3000);
            } else if (newRole && !roleDefinitions[newRole]) {
                showUserFormMessage('התפקיד אינו חוקי', 'error');
            }
        }

        function deleteUser(email) {
            const user = authorizedUsers[email];
            if (!user) return;
            
            if (email === currentUser?.email) {
                alert('אי אפשר למחוק את המשתמש הנוכחי');
                return;
            }
            
            if (confirm(`האם אתה בטוח שברצונך למחוק את המשתמש:\n\n${user.name}\n${email}\n\nפעולה זו אינה ניתנת לביטול!`)) {
                delete authorizedUsers[email];
                
                showUserFormMessage(`✅ המשתמש ${user.name} נמחק מהמערכת`, 'success');
                renderUsersList();
                updatePermissionsStats();
                
                setTimeout(() => {
                    document.getElementById('userFormMessage').innerHTML = '';
                }, 3000);
            }
        }

        function showUserFormMessage(message, type) {
            const messageDiv = document.getElementById('userFormMessage');
            messageDiv.innerHTML = `<div class="${type}-message">${message}</div>`;
        }

        function clearUserForm() {
            document.getElementById('addUserForm').reset();
            document.getElementById('userFormMessage').innerHTML = '';
        }

        function updatePermissionsStats() {
            const users = Object.values(authorizedUsers);
            const totalUsers = users.length;
            const adminUsers = users.filter(u => u.role === 'admin').length;
            const activeUsers = users.filter(u => u.status === 'active').length;
            const onlineUsers = currentUser ? 1 : 0; // Simplified for demo
            
            document.getElementById('totalUsersCount').textContent = totalUsers;
            document.getElementById('adminUsersCount').textContent = adminUsers;
            document.getElementById('activeUsersCount').textContent = activeUsers;
            document.getElementById('onlineUsersCount').textContent = onlineUsers;
        }
		
		// ========================================
// USER PROFILE FUNCTIONS
// ========================================
function openProfileModal() {
    const modal = document.getElementById('profileModal');
    modal.style.display = 'flex';
    
    // Populate current user data
    if (currentUser) {
        document.getElementById('profileName').value = currentUser.name || '';
        document.getElementById('profileEmail').value = currentUser.email || '';
        document.getElementById('profilePassword').value = '';
        
        // Show current role
        const roleLabel = roleDefinitions[currentUser.role]?.label || currentUser.role;
        document.getElementById('currentUserRole').textContent = roleLabel;
    }
    
    // Clear any previous messages
    document.getElementById('profileMessage').innerHTML = '';
}

function closeProfileModal() {
    document.getElementById('profileModal').style.display = 'none';
    clearProfileForm();
}

function updateUserProfile(event) {
    event.preventDefault();
    
    const name = document.getElementById('profileName').value.trim();
    const email = document.getElementById('profileEmail').value.trim();
    const password = document.getElementById('profilePassword').value;
    
    let updated = false;
    
    if (name && name !== currentUser.name) {
        currentUser.name = name;
        document.getElementById('currentUserName').textContent = name;
        if (currentUser.email && authorizedUsers[currentUser.email]) {
            authorizedUsers[currentUser.email].name = name;
        }
        updated = true;
    }
    
    if (email && email !== currentUser.email && email.endsWith('@gov.il')) {
        const oldEmail = currentUser.email;
        if (oldEmail && authorizedUsers[oldEmail] && !authorizedUsers[email]) {
            const userData = authorizedUsers[oldEmail];
            delete authorizedUsers[oldEmail];
            authorizedUsers[email] = userData;
            currentUser.email = email;
        }
        updated = true;
    } else if (email && !email.endsWith('@gov.il')) {
        showProfileMessage('⚠️ המייל חייב להסתיים ב-@gov.il', 'error');
        return;
    }
    
    if (password && password.length >= 6) {
        if (currentUser.email && authorizedUsers[currentUser.email]) {
            authorizedUsers[currentUser.email].password = password;
        }
        updated = true;
    } else if (password && password.length < 6) {
        showProfileMessage('הסיסמה חייבת להכיל לפחות 6 תווים', 'error');
        return;
    }
    
    if (updated) {
        showProfileMessage('✅ הפרטים עודכנו בהצלחה!', 'success');
        setTimeout(() => {
            closeProfileModal();
        }, 2000);
    } else {
        showProfileMessage('לא בוצעו שינויים. מלא לפחות שדה אחד.', 'error');
    }
}

function showProfileMessage(message, type) {
    const messageDiv = document.getElementById('profileMessage');
    messageDiv.innerHTML = `<div class="profile-${type}">${message}</div>`;
}

function clearProfileForm() {
    document.getElementById('profileName').value = '';
    document.getElementById('profileEmail').value = '';
    document.getElementById('profilePassword').value = '';
    document.getElementById('profileMessage').innerHTML = '';
}

        // ========================================
        // DASHBOARD INITIALIZATION
        // ========================================
function initializeDashboard() {
    renderData();
    renderServicePages();
    renderMinistriesSpotlight();
    drawCharts();
    setupEventListeners();
    
    // Show/hide permissions button based on user role
    if (hasPermission('manage_users')) {
        document.querySelector('.permissions-btn').style.display = 'inline-block';
    } else {
        document.querySelector('.permissions-btn').style.display = 'none';
    }
    
    // Initialize GA4 integration
    setTimeout(() => {
        window.ga4Integration = new DashboardGA4Integration();
        console.log('📊 GA4 Integration initialized!');
    }, 500);
    
    console.log('🚀 Dashboard initialized successfully!');
}

        // ========================================
        // DATA RENDERING FUNCTIONS
        // ========================================
        function renderData() {
            const grid = document.getElementById('data-grid');
            let filteredData = getCurrentFilteredData();
			
			if (mockData.length === 0) {
    grid.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: rgba(255,255,255,0.6);">
            <div style="font-size: 64px; margin-bottom: 20px;">📊</div>
            <div style="font-size: 24px; margin-bottom: 15px;">ברוכים הבאים לדשבורד הממשלתי המתקדם</div>
            <div style="font-size: 16px; margin-bottom: 30px;">התחבר ל-Google Analytics 4 כדי להציג נתונים אמיתיים</div>
            <button onclick="window.ga4Integration?.handleGA4Connection()" style="
                background: linear-gradient(135deg, #34a853, #137333);
                border: none; border-radius: 15px; padding: 15px 30px;
                color: white; font-size: 16px; font-weight: 700;
                cursor: pointer; transition: all 0.3s ease;
            ">📊 התחבר עכשיו ל-GA4</button>
        </div>
    `;
    return;
}

            if (filteredData.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">
                        🔍 לא נמצאו תוצאות התואמות לחיפוש
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredData.map(item => `
                <div class="data-item fade-in" onclick="showDetails('${item.title}')">
                    <div class="item-header">
                        <div class="item-title">${item.title}</div>
                        <div class="item-type type-${item.type}">
                            ${getTypeLabel(item.type)}
                        </div>
                    </div>
                    <div class="item-metrics">
                        <div class="metric">
                            <div class="metric-value">${formatNumber(item.users)}</div>
                            <div class="metric-label">משתמשים</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${formatNumber(item.pageviews)}</div>
                            <div class="metric-label">צפיות</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${item.conversion}%</div>
                            <div class="metric-label">המרה</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${item.avgTime}</div>
                            <div class="metric-label">זמן ממוצע</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderServicePages() {
            const grid = document.getElementById('servicePages');
			
			if (servicePages.length === 0) {
    grid.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">
            <div style="font-size: 48px; margin-bottom: 15px;">📊</div>
            <div style="font-size: 18px; margin-bottom: 10px;">ממתין לנתונים מ-Google Analytics</div>
            <div style="font-size: 14px;">לחץ על "התחבר ל-GA4" כדי לטעון נתונים אמיתיים</div>
        </div>
    `;
    return;
}
            
            // Sort service pages by performance
            const sortedServices = [...servicePages].sort((a, b) => b.conversion - a.conversion);
            const topServices = sortedServices.slice(0, 6);
            
            grid.innerHTML = topServices.map((service, index) => `
                <div class="service-card fade-in" onclick="showDetails('${service.title}')">
                    <div class="service-header">
                        <div class="service-info">
                            <div class="service-name">${service.title}</div>
                            <div class="service-ministry">${service.ministry}</div>
                        </div>
                        <div class="service-rank">#${index + 1}</div>
                    </div>
                    <div class="service-metrics">
                        <div class="service-metric">
                            <div class="service-metric-value">${formatNumber(service.users)}</div>
                            <div class="service-metric-label">משתמשים</div>
                        </div>
                        <div class="service-metric">
                            <div class="service-metric-value">${service.conversion}%</div>
                            <div class="service-metric-label">המרה</div>
                        </div>
                        <div class="service-metric">
                            <div class="service-metric-value">${service.performance}</div>
                            <div class="service-metric-label">ביצועים</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderMinistriesSpotlight() {
            const grid = document.getElementById('ministriesGrid');
            let sortedData = [...mockData.filter(item => item.type === 'ministry')];
            
            // Sort by selected metric
            switch(currentMetric) {
                case 'traffic':
                    sortedData.sort((a, b) => b.users - a.users);
                    break;
                case 'conversion':
                    sortedData.sort((a, b) => b.conversion - a.conversion);
                    break;
                case 'engagement':
                    sortedData.sort((a, b) => parseFloat(b.avgTime.replace(':', '.')) - parseFloat(a.avgTime.replace(':', '.')));
                    break;
                case 'performance':
                    sortedData.sort((a, b) => b.performance - a.performance);
                    break;
            }
            
            // Take top 4
            const topMinistries = sortedData.slice(0, 4);
            
            grid.innerHTML = topMinistries.map((item, index) => `
                <div class="ministry-card fade-in" onclick="showDetails('${item.title}')">
                    <div class="ministry-header">
                        <div class="ministry-name">${item.title}</div>
                        <div class="ministry-rank">#${index + 1}</div>
                    </div>
                    <div class="ministry-metrics">
                        <div class="metric">
                            <div class="metric-value">${getMetricValue(item, currentMetric)}</div>
                            <div class="metric-label">${getMetricLabel(currentMetric)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${item.conversion}%</div>
                            <div class="metric-label">המרה</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${formatNumber(item.users)}</div>
                            <div class="metric-label">משתמשים</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${item.performance}</div>
                            <div class="metric-label">ציון ביצועים</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function getCurrentFilteredData() {
            let filteredData = mockData;
            
            if (currentFilter !== 'all') {
                filteredData = filteredData.filter(item => item.type === currentFilter);
            }
            
            if (currentSearch) {
                filteredData = filteredData.filter(item => 
                    item.title.includes(currentSearch) || 
                    item.url.includes(currentSearch)
                );
            }
            
            return filteredData;
        }

        function getTypeLabel(type) {
            const labels = {
                ministry: 'משרד',
                service: 'שירות',
                cluster: 'צובר'
            };
            return labels[type] || type;
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(0) + 'K';
            }
            return num.toString();
        }

        function getMetricValue(item, metric) {
            switch(metric) {
                case 'traffic': return formatNumber(item.users);
                case 'conversion': return item.conversion + '%';
                case 'engagement': return item.avgTime;
                case 'performance': return item.performance;
                default: return formatNumber(item.users);
            }
        }

        function getMetricLabel(metric) {
            const labels = {
                traffic: 'תנועה',
                conversion: 'המרה',
                engagement: 'מעורבות',
                performance: 'ביצועים'
            };
            return labels[metric] || 'תנועה';
        }

        // ========================================
        // FILTER FUNCTIONS
        // ========================================
        function filterData(searchTerm) {
            currentSearch = searchTerm;
            renderData();
        }

        function applyCustomRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate) {
                alert(`📅 הוחל טווח תאריכים: ${startDate} עד ${endDate}`);
                // Here you would update the data based on the date range
            } else {
                alert('⚠️ נא לבחור תאריכי התחלה וסיום');
            }
        }

        function updateStatsForPeriod(period) {
            const multipliers = {
                'today': 0.15,
                'week': 1,
                'month': 4.3,
                'quarter': 12.9
            };
            
            const multiplier = multipliers[period] || 1;
            
            animateValue('total-users', 2400000 * multiplier, 'number');
            animateValue('total-pageviews', 8700000 * multiplier, 'number');
            animateValue('active-services', 156, 'number');
            animateValue('avg-session-time', '4:32', 'time');
        }

        function animateValue(elementId, targetValue, type) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (type === 'time') {
                element.textContent = targetValue;
                return;
            }
            
            const startValue = parseFloat(element.textContent.replace(/[^\d.-]/g, ''));
            const increment = (targetValue - startValue) / 30;
            let currentValue = startValue;
            
            const timer = setInterval(() => {
                currentValue += increment;
                
                if (type === 'number') {
                    element.textContent = formatNumber(Math.round(currentValue));
                } else if (type === 'decimal') {
                    element.textContent = currentValue.toFixed(1) + 's';
                }
                
                if ((increment > 0 && currentValue >= targetValue) || 
                    (increment < 0 && currentValue <= targetValue)) {
                    clearInterval(timer);
                    if (type === 'number') {
                        element.textContent = formatNumber(Math.round(targetValue));
                    } else if (type === 'decimal') {
                        element.textContent = targetValue.toFixed(1) + 's';
                    }
                }
            }, 50);
        }

        // ========================================
        // AI INSIGHTS FUNCTIONS
        // ========================================
        function openDeepInsights() {
            const modal = document.getElementById('aiModal');
            modal.style.display = 'flex';
            
            // Reset content with loading
            document.getElementById('modalInsightsContent').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="loading-spinner"></div>
                    <div style="color: #ff6b9d; font-size: 16px;">האנליסט AI מנתח את הנתונים בעומק...</div>
                </div>
            `;
            
            // Simulate deep analysis
            setTimeout(() => {
                showDeepInsights();
            }, 3000);
        }

        function showDeepInsights() {
            document.getElementById('modalInsightsContent').innerHTML = `
                <div class="insights-grid">
                    <div class="insight-category">
                        <div class="category-title">🚀 ניתוח ביצועים מתקדם</div>
                        
                        <div class="detailed-insight">
                            <div class="insight-title">זינוק בדפי השירות - ניתוח מעמיק</div>
                            <div class="insight-text">
                                דפי השירות מציגים ביצועים יוצאי דופן עם שיעור המרה ממוצע של 28.4%, פי 2.3 מדפי המשרדים הרגילים (12.2%). 
                                הניתוח מצביע על כך שמשתמשים מגיעים לדפי השירות עם כוונה ברורה יותר, מה שמסביר את הזמן הארוך יותר באתר (6:15 דקות ממוצע).
                            </div>
                            <div class="insight-recommendation">
                                💡 המלצה: העבר 30% מהתנועה מדפי משרד לדפי שירות ספציפיים. פוטנציאל לעלייה של 65% בהמרה הכללית.
                            </div>
                        </div>

                        <div class="detailed-insight">
                            <div class="insight-title">אופטימיזציה של זמני טעינה</div>
                            <div class="insight-text">
                                זמני טעינה ארוכים (מעל 3 שניות) במשרד הבריאות גורמים לאובדן של כ-15% מהמשתמשים. 
                                הבעיה ממוקמת בעיקר בדפי הצובר הכבדים עם תמונות לא אופטימיות.
                            </div>
                            <div class="insight-recommendation">
                                🔧 המלצה: הטעיית תמונות, lazy loading, ו-CDN יכולים לקצר זמנים ב-40% ולהוסיף 180K משתמשים חודשיים.
                            </div>
                        </div>
                    </div>

                    <div class="insight-category">
                        <div class="category-title">📊 תובנות התנהגות משתמשים</div>
                        
                        <div class="detailed-insight">
                            <div class="insight-title">מסלולי ניווט אופטימליים</div>
                            <div class="insight-text">
                                76% מהמשתמשים עוזבים לאחר צפייה בדף יחיד, אך אלו שעוברים לדף שני נשארים ממוצע של 8.5 דקות. 
                                קישורים פנימיים ב"שירותי רישוי" מציגים שיעור קליק של 34% - הגבוה ביותר.
                            </div>
                            <div class="insight-recommendation">
                                🏆 המלצה: יישום מערכת קישורים פנימיים דומה בכל הדפים יכול להעלות מעורבות ב-45%.
                            </div>
                        </div>

                        <div class="detailed-insight">
                            <div class="insight-title">תזמון פעילות משתמשים</div>
                            <div class="insight-text">
                                שיא פעילות בין 10:00-12:00 (34% מהתנועה היומית) ו-14:00-16:00 (28%). 
                                ימי שישי מציגים ירידה של 45% בתנועה, אך עלייה של 23% בזמן שהייה.
                            </div>
                            <div class="insight-recommendation">
                                ⏰ המלצה: תזמון עדכונים ותחזוקה לשעות לא פיק, וחיזוק תוכן באמצע השבוע.
                            </div>
                        </div>
                    </div>

                    <div class="insight-category">
                        <div class="category-title">💰 השפעה כלכלית ופוטנציאל צמיחה</div>
                        
                        <div class="detailed-insight">
                            <div class="insight-title">חיסכון בעלויות תפעול</div>
                            <div class="insight-text">
                                כל 1% שיפור בשיעור ההמרה מקביל לחיסכון של כ-2.3 מיליון ₪ בעלויות תפעול שנתיות, 
                                בעיקר בגלל הפחתת הצורך באיפול ידני ושיחות למוקד.
                            </div>
                            <div class="insight-recommendation">
                                💰 ROI: השקעה של 500K ₪ באופטימיזציה צפויה להחזיר 4.2M ₪ תוך 12 חודשים.
                            </div>
                        </div>

                        <div class="detailed-insight">
                            <div class="insight-title">הזדמנויות צמיחה מיידיות</div>
                            <div class="insight-text">
                                3 משרדים מובילים (פנים, בריאות, חינוך) מהווים 67% מהתנועה אך רק 34% מדפי השירות. 
                                פיתוח 12 דפי שירות נוספים עבור משרדים אלו יכול להכפיל את הרווחיות.
                            </div>
                            <div class="insight-recommendation">
                                📈 פוטנציאל: 2.8M משתמשים נוספים ושיפור המרה כללי של 78% תוך 6 חודשים.
                            </div>
                        </div>
                    </div>

                    <div class="insight-category">
                        <div class="category-title">🏆 תכנית פעולה מומלצת</div>
                        
                        <div class="detailed-insight">
                            <div class="insight-title">יעדים קצרי טווח (30 יום)</div>
                            <div class="insight-text">
                                1. אופטימיזציה של 5 דפי הצובר הכבדים ביותר<br>
                                2. הוספת 20 קישורים פנימיים אסטרטגיים<br>
                                3. A/B testing לעיצוב כפתורי CTA<br>
                                4. שדרוג מערכת החיפוש הפנימית
                            </div>
                            <div class="insight-recommendation">
                                🏆 יעד: שיפור המרה ב-15% ועלייה של 8% במשתמשים חוזרים.
                            </div>
                        </div>

                        <div class="detailed-insight">
                            <div class="insight-title">יעדים ארוכי טווח (6 חודשים)</div>
                            <div class="insight-text">
                                1. פיתוח 15 דפי שירות חדשים למשרדים מובילים<br>
                                2. מערכת המלצות מותאמת אישית<br>
                                3. אינטגרציה עם מערכות CRM ממשלתיות<br>
                                4. מעקב התנהגות מתקדם עם AI
                            </div>
                            <div class="insight-recommendation">
                                🚀 יעד: הכפלת ההמרה הכללית והפיכת הפלטפורמה למובילה עולמית בשירותים ממשלתיים דיגיטליים.
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('aiModal').style.display = 'none';
        }

        // ========================================
        // CHART FUNCTIONS
        // ========================================
        function drawCharts() {
            drawTrafficChart();
            drawServicesChart();
        }

        function drawTrafficChart() {
            const canvas = document.getElementById('trafficCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const width = canvas.width - 80;
            const height = canvas.height - 80;
            const startX = 40;
            const startY = 40;
            
            const data = [
                { label: 'דפי משרד', value: 35, color: '#64ffda' },
                { label: 'דפי שירות', value: 45, color: '#448aff' },
                { label: 'דפי צובר', value: 20, color: '#7c4dff' }
            ];
            
            let currentAngle = -Math.PI / 2;
            const centerX = startX + width / 2;
            const centerY = startY + height / 2;
            const radius = Math.min(width, height) / 2.5;
            
            data.forEach((item) => {
                const sliceAngle = (item.value / 100) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = item.color;
                ctx.fill();
                
                // Add border
                ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                const labelAngle = currentAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius + 30);
                const labelY = centerY + Math.sin(labelAngle) * (radius + 30);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = '14px Assistant';
                ctx.textAlign = 'center';
                ctx.fillText(`${item.label}`, labelX, labelY);
                ctx.font = 'bold 16px Assistant';
                ctx.fillText(`${item.value}%`, labelX, labelY + 18);
                
                currentAngle += sliceAngle;
            });
        }

        function drawServicesChart() {
            const canvas = document.getElementById('servicesCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const width = canvas.width - 100;
            const height = canvas.height - 80;
            const startX = 50;
            const startY = 40;
            
            const services = [
                { name: 'רישוי דיגיטלי', value: 96 },
                { name: 'בריאות דיגיטלי', value: 94 },
                { name: 'רישיון נהיגה', value: 92 },
                { name: 'תעודת זהות', value: 88 },
                { name: 'דיווח מס', value: 85 },
                { name: 'מלגות סטודנטים', value: 82 }
            ];
            
            const maxValue = Math.max(...services.map(s => s.value));
            const barHeight = (height - 60) / services.length - 12;
            
            services.forEach((service, index) => {
                const barWidth = (service.value / maxValue) * (width - 140);
                const y = startY + index * (barHeight + 12);
                
                // Create gradient
                const gradient = ctx.createLinearGradient(startX + 100, 0, startX + 100 + barWidth, 0);
                gradient.addColorStop(0, '#64ffda');
                gradient.addColorStop(0.5, '#448aff');
                gradient.addColorStop(1, '#7c4dff');
                
                // Draw bar
                ctx.fillStyle = gradient;
                ctx.fillRect(startX + 100, y, barWidth, barHeight);
                
                // Add border
                ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                ctx.lineWidth = 1;
                ctx.strokeRect(startX + 100, y, barWidth, barHeight);
                
                // Draw service name
                ctx.fillStyle = '#ffffff';
                ctx.font = '12px Assistant';
                ctx.textAlign = 'right';
                ctx.fillText(service.name, startX + 95, y + barHeight / 2 + 4);
                
                // Draw value
                ctx.textAlign = 'left';
                ctx.font = 'bold 13px Assistant';
                ctx.fillText(`${service.value}%`, startX + 105 + barWidth, y + barHeight / 2 + 4);
            });
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function showDetails(title) {
            const item = mockData.find(d => d.title === title);
            if (item) {
                alert(`📋 פרטים מלאים: ${title}\n\n` +
                     `🌐 URL: ${item.url}\n` +
                     `👥 משתמשים: ${item.users.toLocaleString()}\n` +
                     `📄 צפיות: ${item.pageviews.toLocaleString()}\n` +
                     `⏱️ זמן ממוצע: ${item.avgTime}\n` +
                     `📉 שיעור נטישה: ${item.bounceRate}%\n` +
                     `🏆 שיעור המרה: ${item.conversion}%\n` +
                     `⭐ ציון ביצועים: ${item.performance}/100`);
            }
        }

        function exportData(format) {
            alert(`📊 יוצא נתונים בפורמט ${format.toUpperCase()}... הקובץ ישמר בהורדות.`);
        }

        // ========================================
        // EVENT LISTENERS SETUP
        // ========================================
        function setupEventListeners() {
            // Type filters
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.getAttribute('data-filter');
                    renderData();
                });
            });

            // Period filters
            document.querySelectorAll('[data-period]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    updateStatsForPeriod(this.getAttribute('data-period'));
                });
            });

            // Spotlight tabs
            document.querySelectorAll('.spotlight-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.spotlight-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentMetric = this.getAttribute('data-metric');
                    renderMinistriesSpotlight();
                });
            });

            // Close modal when clicking outside
            document.getElementById('aiModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeModal();
                }
            });
            
            // Close permissions modal when clicking outside
            document.getElementById('permissionsModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closePermissionsModal();
                }
            });

            // Hover effects
            document.addEventListener('mouseover', function(e) {
                if (e.target.classList.contains('stat-card') || e.target.classList.contains('ministry-card')) {
                    e.target.style.transform = 'translateY(-8px) scale(1.02)';
                }
            });

            document.addEventListener('mouseout', function(e) {
                if (e.target.classList.contains('stat-card') || e.target.classList.contains('ministry-card')) {
                    e.target.style.transform = 'translateY(0) scale(1)';
                }
            });
        }

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Government Dashboard System Loading...');
            
            // Check if user is already logged in (for demo purposes)
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('currentUserName').textContent = currentUser.name;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboardPage').style.display = 'block';
                initializeDashboard();
            }
            
            console.log('✅ System Ready');
            console.log('🔧 Demo Users: netanel.cooperman@gov.il (123456), sarah.cohen@gov.il (password), david.levy@gov.il (viewer123)');
        });

        // Save current user to localStorage for demo persistence
        function saveUserSession() {
            if (currentUser) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            } else {
                localStorage.removeItem('currentUser');
            }
        }

        // Override logout to clear session
        const originalLogout = logout;
        logout = function() {
            originalLogout();
            saveUserSession();
        };

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('Dashboard Error:', e.error);
        });

        console.log('🏉 נתנאל קופרמן\'s Government Dashboard - Ready to impress! 🚀');


    </script>
</body>
</html>